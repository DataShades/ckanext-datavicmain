{% ckan_extends %}

{% import "macros/form.html" as form %}

{# Note: 
Remove 'free extras' from the package form. If you're using convert_{to/from}_extras() as we are 
with our 'music_description' field below then you need to remove free extras from the form, or editing 
your custom field won't work!! 
#}
{% block custom_fields %}
{% endblock %}

{% block package_metadata_fields %}

  {% for field_id, field_attributes in h.dataset_extra_fields %}
    {% if field_id in ['agency_program_domain', 'category'] %}
      {% if field_id == 'category' %}
        {% set package_groups = data.get('groups', []) %}
        {% set category = package_groups[0]['id'] if package_groups[0] else None %}
        {{ form.select(field_id,
          label=_(field_attributes['label']), id='field-' + field_id,
          options = h.group_list(),
          selected = category,
          attrs = { 'data-module': 'no-autocomplete' },
          error=errors.get(field_id),
          is_required=true)
        }}
      {% else %}
        {{ form.input(field_id,
          label=_(field_attributes['label']), id='field-' + field_id,
          placeholder=_(field_attributes['label']),
          value=data.get(field_id),
          error=errors.get(field_id),
          classes=['control-medium'],
          is_required=field_attributes['required']|default(false))
        }}
      {% endif %}
      {% if field_attributes['description'] %}
        <small>{{ field_attributes['description'] }}</small>
      {% endif %}
    {% endif %}
  {% endfor %}

  <div class="control-group">
    {% set error = errors.license_id %}
    <label class="control-label" for="field-license"><span title="This field is required" class="control-required">*</span> {{ _("License") }}</label>
    <div class="controls">
      <select id="field-license" name="license_id" data-module="autocomplete">
        {% set existing_license_id = data.get('license_id') %}
        {% for license_id, license_desc in h.license_options(existing_license_id) %}
          <option value="{{ license_id }}" {% if existing_license_id == license_id %}selected="selected"{% endif %}>{{ license_desc }}</option>
        {% endfor %}
      </select>
      {% if error %}<span class="error-block">{{ error }}</span>{% endif %}
      <span class="info-block info-inline">
        <i class="icon-info-sign"></i>
        {% trans %}
          License definitions and additional information can be found
          at <a href="http://opendefinition.org/licenses/">opendefinition.org</a>
        {% endtrans %}
      </span>
    </div>
  </div>

  {% for field_id, field_attributes in h.dataset_extra_fields %}
    {% if field_attributes['hidden'] != True and field_attributes['field_group'] in ['general'] %}
        {% if field_attributes['field_type'] and field_attributes['field_type'] == 'date' %}
          {{ form.input(field_id,
            label=_(field_attributes['label']), id='field-' + field_id,
            placeholder=_('YYYY-MM-DD'),
            value=data.get(field_id),
            error=errors.get(field_id),
            classes=['control-small calendar'],
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'yes_no' %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = h.yes_no_options(),
            selected = data.get(field_id, None),
            attrs = { 'data-module': 'no-autocomplete' },
            error=errors.get(field_id),
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'select' %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = field_attributes['options'],
            selected = data.get(field_id, None),
            attrs = { 'data-module': 'no-autocomplete' },
            error=errors.get(field_id),
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'textarea' %}
          {{ form.textarea(field_id,
            label = _(field_attributes['label']),
            value=data.get(field_id),
            error=errors.get(field_id),
            classes=['control-full'],
            is_required=field_attributes['required']|default(false))
          }}
        {% else  %}
          {{ form.input(field_id,
            label=_(field_attributes['label']), id='field-' + field_id,
            placeholder=_(field_attributes['label']),
            value=data.get(field_id),
            error=errors.get(field_id),
            classes=['control-medium'],
            is_required=field_attributes['required']|default(false))
          }}
        {% endif %}
        {% if field_attributes['description'] %}
        <small>{{ field_attributes['description'] }}</small>
        {% endif %}
    {% endif %}
  {% endfor %}

  <h2>Security</h2>

  {% for field_id, field_attributes in h.dataset_extra_fields %}
    {% if field_attributes['hidden'] != True and field_attributes['field_group'] in ['security'] %}
        {% if field_id == 'category' %}
          {% set package_groups = data.get('groups', []) %}
          {% set category = package_groups[0]['id'] if package_groups[0] else None %}
          {{ form.select(field_id,
            label=_(field_attributes['label']), id='field-' + field_id,
            options = h.group_list(),
            selected = category,
            attrs = { 'data-module': 'no-autocomplete' },
            error=errors.get(field_id),
            is_required=true)
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'date' %}
          {{ form.input(field_id,
            label=_(field_attributes['label']), id='field-' + field_id,
            placeholder=_('YYYY-MM-DD'),
            value=data.get(field_id),
            error=errors.get(field_id),
            classes=['control-small calendar'],
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'yes_no' %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = h.yes_no_options(),
            selected = data.get(field_id, None),
            attrs = { 'data-module': 'no-autocomplete' },
            error=errors.get(field_id),
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'select' %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = field_attributes['options'],
            selected = data.get(field_id, None),
            attrs = { 'data-module': 'no-autocomplete' },
            error=errors.get(field_id),
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'textarea' %}
          {{ form.textarea(field_id,
            label = _(field_attributes['label']),
            value=data.get(field_id),
            error=errors.get(field_id),
            classes=['control-full'],
            is_required=field_attributes['required']|default(false))
          }}
        {% else  %}
          {{ form.input(field_id,
            label=_(field_attributes['label']), id='field-' + field_id,
            placeholder=_(field_attributes['label']),
            value=data.get(field_id),
            error=errors.get(field_id),
            classes=['control-medium'],
            is_required=field_attributes['required']|default(false))
          }}
        {% endif %}
        {% if field_attributes['description'] %}
        <small>{{ field_attributes['description'] }}</small>
        {% endif %}
    {% endif %}
  {% endfor %}

  <h2>Workflow</h2>

  {% for field_id, field_attributes in h.dataset_extra_fields %}
    {% if field_attributes['hidden'] != True and field_attributes['field_group'] in ['workflow_1'] %}
        {% if field_id == 'organization_visibility'  %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = h.organization_visibility_options(),
            selected = data.get(field_id, None),
            attrs = { 'data-module': 'no-autocomplete' },
            is_required = true)
          }}
      {% endif %}
    {% endif %}
  {% endfor %}

  <div class="control-group">
    <label for="field-private" class="control-label">
      <span title="This field is required" class="control-required">*</span>
      {{ _('Public Release') }}
    </label>
    <div class="controls">
      <select id="field-private" name="private">
        {% for option in [('True', _('No')), ('False', _('Yes'))] %}
          <option value="{{ option[0] }}" {% if option[0] == data.private|trim %}selected="selected"{% endif %}>{{ option[1] }}</option>
        {% endfor %}
      </select>
      <span class="info-block info-inline">
        <strong>Public Release</strong> can only be set to <strong>'Yes'</strong> if Workflow Status is 'Published' and Organisation Visibility is 'All'
      </span>
    </div>
  </div>

  {% for field_id, field_attributes in h.dataset_extra_fields %}
    {% if field_attributes['hidden'] != True and field_attributes['field_group'] in ['workflow_2'] %}
        {% if field_id == 'workflow_status'  %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = h.workflow_status_options(data.get(field_id, None), data.get('owner_org', None)),
            selected = h.autoselect_workflow_status_option(data.get(field_id, 'draft')),
            attrs = { 'data-module': 'no-autocomplete' },
            is_required = true)
          }}
        {% elif field_attributes['field_type'] and field_attributes['field_type'] == 'select' %}
          {{ form.select(field_id,
            label = _(field_attributes['label']),
            options = field_attributes['options'],
            selected = data.get(field_id, None),
            attrs = { 'data-module': 'no-autocomplete' },
            error=errors.get(field_id),
            is_required=field_attributes['required']|default(false))
          }}
        {% elif field_id == 'workflow_status_notes'  %}
            {% if h.is_admin(data.get('owner_org', None)) %}
                {{ form.textarea(field_id,
                    label = _(field_attributes['label']),
                    value=data.get(field_id),
                    error=errors.get(field_id),
                    classes=['control-medium'])
                }}
            {% endif %}
        {% endif %}
    {% endif %}
  {% endfor %}

  {% block package_metadata_fields_url %}
  {% endblock %}

  {% block package_metadata_author %}
  {% endblock %}

  {% block package_metadata_fields_version %}
  {% endblock %}


  {% block package_metadata_fields_maintainer %}
    {% if c.controller == 'package' and c.action == 'edit' %}
        {{ form.input('data_owner', label=_('Data Owner'), id='field-data-owner', value=data.data_owner, error=errors.data_owner, classes=['control-medium']) }}
    {% endif %}

    {{ form.input('maintainer', label=_('Data Custodian'), id='field-maintainer', placeholder=_('Joe Bloggs'), value=data.maintainer, error=errors.maintainer, classes=['control-medium']) }}
      {{ form.input('role',
        label=_('Role'), id='field-role',
        placeholder=_('Role'),
        value=data.get('role'),
        error=errors.get('role'),
        classes=['control-medium'])
      }}

    {{ form.input('maintainer_email', label=_('Email'), id='field-maintainer-email', placeholder=_('joe@example.com'), value=data.maintainer_email|default(tmpl_context.userobj.email), error=errors.maintainer_email, classes=['control-medium']) }}
  {% endblock %}

  {#
    {{ super() }}
  #}

  {% resource 'ckanext-datavicmain/jquery-ui.js' %}
  {% resource 'ckanext-datavicmain/jquery-ui.css' %}
  {% resource 'ckanext-datavicmain/jquery-ui.structure.css' %}
  {% resource 'ckanext-datavicmain/datavicmain.js' %}

{% endblock %}
